## java 内存区域

### 运行时数据区域

![](https://oscimg.oschina.net/oscnet/up-f27e86aeb03a57f0066fdb1e9d72eccf69d.png)

##### 程序计数器
* 一块较小的内存空间，看作是当前线程所执行的字节码的行号指示器。
* Java 多线程是通过线程轮流切换并分配处理器执行时间来实现的，因此，每条线程都有独立的程序计数器，是线程私有的内存。
* 若线程在执行一个java 方法，则计数器记录的是字节码指令的地址；若是本地Native 方法，则计数器为空。
* 此区域是唯一一个在java 虚拟机规范中没有规定任何 OutOfMemoryError 情况的区域

##### Java 虚拟机栈
* 线程私有的，它的生命周期与线程相同
* 虚拟机栈描述的是Java 方法执行的内存模型：
    * 每个方法在执行的同时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息
    * 每个方法从调用直到执行完成的过程，就对应一个栈帧在虚拟机栈中入栈到出栈的过程
* 通常说的堆内存Heap 和栈内存Stack，栈指的就是虚拟机栈中的局部变量表
* 局部变量表存放了编译期可知的各种数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference 对象）、returnAddress 类型（指向了一条字节码指令的地址）
* 局部变量表所需的内存空间在编译期间完成分配，一个方法在栈帧中分配多大的局部变量空间是完全确定的
    * 64位长度的long 和double 类型的数据占用两个局部变量空间（Slot）
    * 其他数据类型占用一个Slot
* 该区域规定了两种异常状态：
    * 如果线程请求的栈深度大于虚拟机所允许的深度，抛出 StackOverflowError 异常
    * 如果虚拟机栈无法申请到足够的内存，抛出 OutOfMemoryError 异常

##### 本地方法栈
* 本地方法栈与虚拟机栈相似，只不过为虚拟机使用到的Native 方法服务
* HotSpot 虚拟机将本地方法栈和虚拟机栈合二为一
* 也会抛出StackOverflowError 和 OutOfMemoryError 异常

##### Java 堆
* 内存中最大的一块，并且是被所有线程共享的一块内存区域，在虚拟机启动时创建
* 存放几乎所有的对象实例，JIT 编译器与逃逸分析技术的发展，栈上分配、标量替换让所有对象都在堆上分配变得不那么绝对了
* 是垃圾收集器管理的主要区域
* 一般是可扩展的，通过-Xms 和-Xmx 控制，无法再扩展时，抛出 OutOfMemoryError 异常

##### 方法区
* 线程共享的内存区域，用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译的代码等数据
* 无法满足内存需求时，抛出 OutOfMemoryError 异常

##### 运行时常量池
* 是方法区的一部分，Class 文件有一项信息是常量池，用于存放编译期生成的各种字面量和符号引用，在类加载后进入运行时常量池
* 运行时常量池相对于Class 文件常量池是具备动态性，允许运行期间将新的常量放入池中，例如 String 的intern() 方法
* 也会抛出 OutOfMemoryError 异常

##### 直接内存
* 并不是虚拟机运行时的数据区的一部分，也不是规范中定义的内存区域
* 它使用Native 函数库直接分配堆外内存，通过存储在堆中的DirectByteBuffer 对象作为这块内存的引用，避免了在Java 堆和Native 堆中来回复制数据
* 不受Java 堆大小的限制，受本机总内存大小以及处理器寻址空间的限制
* 也会抛出 OutOfMemoryError 异常


### 虚拟机对象

##### 创建对象

![](https://oscimg.oschina.net/oscnet/up-f2c422c3e896da4bf478e9e9debe4252e36.png)

内存分配的方式：
* 指针碰撞 Bump the Pointer
    * 若Java 堆内存是绝对规整的，用过的内存在一边，空闲的内存在另一边，中间放着指针作为分界点的指示器
    * 分配内存仅仅是把那个指针向空闲空间那边挪动一段与对象大小相等的距离，这种分配方式称为 指针碰撞
* 空闲列表 Free List
    * 若Java 内存并不是规整的，已使用的内存和空闲的内存相互交错
    * 需要维护一个列表，记录哪块内存是可用的，在分配的时候从列表中找一块足够大的空间划分给对象实例，并更新列表上的记录




















