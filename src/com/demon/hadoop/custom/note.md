## 海量数据问题处理思路

分布式存储、分布式并行计算

#### 需求

* 后台有100W个搜索日志文件，总大小约100T，求每天搜索中，热度最高的10个问题
解决方案：一个大问题拆分成多个小问题来解决，将100T 分为10000个小文件（分而治之），并行运行10000个任务，最终汇总

* 后台有100W个搜索日志文件，总大小约100T，求昨天和今天的共同会员
解决方案：对两天的数据都进行hash 散列，只需要将第一天的第一个分区和第二天的第一个分区求交集，其余类似

* 快速判断7天内的日志数据中，判断某个用户ID 是否存在

> 海量数据的计算解决方案：多个小任务并行执行运算，再执行第二个阶段的汇总


## 通信模型
* JDK 原生的BIO，阻塞式IO，无法支撑高并发
    * 客户端和服务线程是1：1的，服务器资源不够用
    * 有两处阻塞的方法实现：serverSocket.accept() 和 inputStream.readLine()
* JDK 原生的NIO，非阻塞式IO，可以支持高并发，但自己实现复杂
    * 通过selector 管理链接请求，用来调度应用程序的执行
* 基于NIO 的Netty 框架，封装好，API 易用
* JDK 1.7 之后提供的AIO，真正的异步编程模型


## RPC 的调用过程
```
1、client 调用本地动态代理proxy
2、这个代理会通过协议序列化字节流
3、通过netty 网络框架，将字节流发送到服务器
4、服务器收到这个字节流后，反序列化为原始的调用，利用反射原理调用服务方提供的方法
5、如果请求有返回值，把返回值根据协议序列化，再通过netty 返回给客户端
```

## 文件系统
常见的文件系统：windows、mac、linux，特点都是树形的结构

海量数据的存储原理：分布式的分散存储
* 分散存储：将大文件分割成小文件，分别存储在不同的服务器上
```
产生的问题：
1、服务器的宕机的可能。解决方案：多副本冗余存储
2、文件系统中，描述性的数据需要记录，例如，数据块/小文件，属于哪个文件
    解决方案：数据存储在元数据中
    ！产生的另一个问题：海量数据，元数据非常多，那么存储在内存还是硬盘？
    * 如果为了保证数据安全，数据必须放在磁盘
    * 如果为了保证数据的读写高效，数据必须放在内存
    * 理想情况：两个都放
        ！产生的新的问题：磁盘和内存的数据如何保证一致？
        * WAL 机制：所有的影响数据状态的操作，都应该记录操作日志，然后更新数据到内存（做事务保证）
            操作日志可以做数据恢复
```

#### 上传数据的流程
* 规划
    * 先算出来有几个数据块（file_length / block_size + 1）
    * 给每个数据块找n 个不同的服务节点（block_replication）
* 实现小文件上传
    * 依次上传每个数据块n 个副本的传输
    * 一次传输一个数据块，再复制额外的n-1 个副本
* 记录元数据
    * 上传的文件在文件系统的存储目录
    * 上传的文件由哪些数据块组成
    * 每个数据块的多个副本，都是存储在哪些服务器
    * 如果系统可以重启，那么内存中还需要包含之前的元数据





